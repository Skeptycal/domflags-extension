// Generated by CoffeeScript 1.6.3
var ports, updateContextMenus,
  __hasProp = {}.hasOwnProperty;

console.log("background.js");

updateContextMenus = function(flags, port) {
  var key, onClickHandler, value, _results;
  onClickHandler = function(info, tab) {
    console.log(port);
    return port.postMessage({
      name: "contextMenuClick",
      key: info.menuItemId,
      tab: tab
    });
  };
  if (flags.length > 0) {
    _results = [];
    for (key in flags) {
      if (!__hasProp.call(flags, key)) continue;
      value = flags[key];
      _results.push(chrome.contextMenus.create({
        title: value,
        id: "" + key,
        contexts: ['all'],
        onclick: onClickHandler
      }));
    }
    return _results;
  }
};

ports = [];

chrome.runtime.onConnect.addListener(function(port) {
  if (port.name !== "devtools") {
    return;
  }
  port.onMessage.addListener(function(msg) {
    return chrome.tabs.query({
      lastFocusedWindow: true,
      active: true
    }, function(tabs) {
      ports[tabs[0].id] = {
        port: port,
        portId: port.portId_,
        tab: tabs[0].id
      };
      return chrome.tabs.sendMessage(tabs[0].id, "Give me domflags", function(response) {
        if (response) {
          return updateContextMenus(response.flags, port);
        }
      });
    });
  });
  port.onDisconnect.addListener(function(port) {
    chrome.contextMenus.removeAll();
    console.log(ports[port.portId_]);
    return delete ports[port.portId_];
  });
  return chrome.tabs.onActivated.addListener(function(activeInfo) {
    return chrome.tabs.query({
      lastFocusedWindow: true,
      active: true
    }, function(tabs) {
      return chrome.tabs.sendMessage(tabs[0].id, "Give me domflags", function(response) {
        if (response) {
          return updateContextMenus(response.flags, ports[tabs[0].id].port);
        }
      });
    });
  });
});

chrome.tabs.onActivated.addListener(function(activeInfo) {
  console.log(ports);
  return chrome.contextMenus.removeAll();
});
