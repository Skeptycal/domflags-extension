// Generated by CoffeeScript 1.7.1
(function() {
  var __hasProp = {}.hasOwnProperty;

  $(document).ready(function() {
    var $domflags, WatchDOMFlags;
    WatchDOMFlags = (function() {
      function WatchDOMFlags(domflags) {
        this.domflagsPanel = $('#domflags-panel');
        this.domflags = domflags;
        this.flaggedElements = [];
        this.constructFlagEls();
        this.setupDomObserver();
      }

      WatchDOMFlags.prototype.constructFlagEls = function() {
        var elString, key, _ref;
        if (this.domflags.length > 0) {
          _ref = this.domflags;
          for (key in _ref) {
            if (!__hasProp.call(_ref, key)) continue;
            if ($.isNumeric(key)) {
              elString = this.elToString(this.domflags[key]);
              this.flaggedElements.push(elString);
            }
          }
          return this.backgroundListener();
        }
      };

      WatchDOMFlags.prototype.backgroundListener = function() {
        this.pageReloaded();
        if (!this.domflagsPanel.is(":visible")) {
          return chrome.runtime.onMessage.addListener((function(_this) {
            return function(message, sender, sendResponse) {
              if (message === "Remove panel") {
                return _this.domflagsPanel.remove();
              } else if (message === "Give me domflags") {
                sendResponse({
                  flags: _this.flaggedElements
                });
                return _this.createDomflagsPanel();
              } else if (message === "Tab change") {
                return sendResponse({
                  flags: _this.flaggedElements
                });
              }
            };
          })(this));
        }
      };

      WatchDOMFlags.prototype.pageReloaded = function() {
        return chrome.runtime.sendMessage({
          name: "pageReloaded"
        });
      };

      WatchDOMFlags.prototype.createDomflagsPanel = function() {
        var el, elements, key, value, _ref;
        if (!this.domflagsPanel.is(":visible")) {
          this.appendDomflagsPanel();
        }
        elements = "";
        _ref = this.flaggedElements;
        for (key in _ref) {
          if (!__hasProp.call(_ref, key)) continue;
          value = _ref[key];
          if ($.isNumeric(key)) {
            el = "<domflags-li class='domflags-li' data-key='" + key + "'>" + value + "</domflags-li>";
            elements = "" + elements + " " + el;
          }
        }
        return this.domflagsPanel.find('.domflags-ol').append(elements);
      };

      WatchDOMFlags.prototype.appendDomflagsPanel = function() {
        var html;
        html = "<domflags-panel id=\"domflags-panel\" class=\"bottom left opened\">\n  <domflags-header class=\"domflags-header\">DOMFLAGS</domflags-header>\n  <domflags-button class=\"domflags-button right\"></domflags-button>\n  <domflags-ol class=\"domflags-ol\"></domflags-ol>\n</domflags-panel>";
        $(document.body).append(html);
        this.domflagsPanel = $('#domflags-panel');
        return this.setupDomPanelListeners();
      };

      WatchDOMFlags.prototype.setupDomPanelListeners = function() {
        return this.domflagsPanel.get(0).addEventListener('click', (function(_this) {
          return function(event) {
            var key, listHeight, oldPos, targetPos;
            if (event.target.className === 'domflags-li') {
              key = $(event.target).attr('data-key');
              return chrome.runtime.sendMessage({
                name: "panelClick",
                key: key
              });
            } else if (event.target.className === 'domflags-header') {
              if (_this.domflagsPanel.hasClass('opened')) {
                listHeight = _this.domflagsPanel.find('.domflags-ol').outerHeight() + 1;
                _this.domflagsPanel.removeClass('opened').addClass('closed');
                return _this.domflagsPanel.css('transform', "translateY(" + listHeight + "px)");
              } else if (_this.domflagsPanel.hasClass('closed')) {
                _this.domflagsPanel.removeClass('closed').addClass('opened');
                return _this.domflagsPanel.css('transform', "translateY(0px)");
              }
            } else if (event.target.classList[0] === 'domflags-button') {
              targetPos = event.target.classList[1];
              if (targetPos === "left") {
                oldPos = "right";
              } else if (targetPos === "right") {
                oldPos = "left";
              }
              _this.domflagsPanel.removeClass(oldPos).addClass(targetPos);
              return $(event.target).removeClass(targetPos).addClass(oldPos);
            }
          };
        })(this));
      };

      WatchDOMFlags.prototype.elToString = function(node) {
        var domArray, elString, key, value, _ref;
        domArray = [node.tagName];
        _ref = node.attributes;
        for (key in _ref) {
          if (!__hasProp.call(_ref, key)) continue;
          value = _ref[key];
          if (($.isNumeric(key)) && (value.name !== "domflag")) {
            domArray.push("" + value.name + "='" + value.value + "'");
          }
        }
        elString = domArray.join(' ');
        return elString;
      };

      WatchDOMFlags.prototype.refreshDomPanel = function() {
        $('.domflags-li').remove();
        this.flaggedElements = [];
        this.domflags = $('[domflag]');
        return this.constructFlagEls();
      };

      WatchDOMFlags.prototype.setupDomObserver = function() {
        var config, observer;
        observer = new MutationObserver((function(_this) {
          return function(mutations) {
            return mutations.forEach(function(mutation) {
              var addedNodes, key, node, nodeChange, removedNodes, value, _results;
              if (mutation.type === "childList") {
                removedNodes = mutation.removedNodes;
                addedNodes = mutation.addedNodes;
                nodeChange = (function() {
                  switch (false) {
                    case !(removedNodes.length >= 1):
                      return removedNodes;
                    case !(addedNodes.length >= 1):
                      return addedNodes;
                    default:
                      return void 0;
                  }
                })();
                if (nodeChange) {
                  _results = [];
                  for (key in nodeChange) {
                    if (!__hasProp.call(nodeChange, key)) continue;
                    value = nodeChange[key];
                    node = nodeChange[key];
                    _results.push((function() {
                      var _ref, _results1;
                      _ref = node.attributes;
                      _results1 = [];
                      for (key in _ref) {
                        if (!__hasProp.call(_ref, key)) continue;
                        value = _ref[key];
                        if (value.name === "domflag") {
                          _results1.push(this.refreshDomPanel());
                        } else {
                          _results1.push(void 0);
                        }
                      }
                      return _results1;
                    }).call(_this));
                  }
                  return _results;
                }
              } else if (mutation.type === "attributes") {
                if ((mutation.oldValue === "") || (mutation.oldValue === null)) {
                  return _this.refreshDomPanel();
                }
              }
            });
          };
        })(this));
        config = {
          attributeFilter: ['domflag'],
          attributeOldValue: true,
          attributes: true,
          childList: true,
          subtree: true
        };
        return observer.observe(document.body, config);
      };

      return WatchDOMFlags;

    })();
    $domflags = $('[domflag]');
    return new WatchDOMFlags($domflags);
  });

}).call(this);
